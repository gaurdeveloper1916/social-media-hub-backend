service: express-lambda-app

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-south-1
  memorySize: 512
  timeout: 10

  httpApi:
    cors: true

  environment:
    NODE_ENV: production
    MONGODB_URI: mongodb+srv://marketingthefarms_db_user:The%40Palatial%21fARMS%402025@cluster0.l3ejm.mongodb.net/mydb?retryWrites=true&w=majority

    # Redis
    REDIS_HOST: ${env:REDIS_HOST}
    REDIS_PORT: ${env:REDIS_PORT}
    REDIS_PASSWORD: ${env:REDIS_PASSWORD}

    # WhatsApp Cloud API
    WHATSAPP_BUSINESS_ID: ${env:WHATSAPP_BUSINESS_ID}
    PHONE_NUMBER_ID: ${env:PHONE_NUMBER_ID}
    WHATSAPP_TOKEN: ${env:WHATSAPP_TOKEN}

    # Firebase (stringified JSON recommended)
    FIREBASE_SERVICE_ACCOUNT: ${env:FIREBASE_SERVICE_ACCOUNT}

functions:
  app:
    handler: handler.handler
    events:
      - httpApi:
          path: /{proxy+}
          method: ANY

plugins:
  - serverless-offline

# Serverless v4 built-in ESBuild
build:
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    target: node20
    platform: node
    external:
      - aws-sdk
      - '@aws-sdk/*'

package:
  patterns:
    - '!**/.env'
    - '!**/*.log'
    - '!**/.git/**'
    - '!**/.vscode/**'
    - '!node_modules/aws-sdk/**'
